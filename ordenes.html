<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Burger - Bienvenido</title>
       <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+YffS3ZT+JdbD9lM9OquDTMCp+oj+7zK1WEnKbV1JlF99k0yEhe7r9GqQXOxkOsl" crossorigin="anonymous">
<link href="css/style.css" rel="stylesheet">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">


<!-- Bootstrap Bundle con Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<style>
    .list-group{
        padding: 5px;;
    }

    
    .page-footer {
        position: fixed;     /* se queda fijo */
        bottom: 0;           /* pegado al fondo */
        left: 0;
        width: 100%;         /* ocupa todo el ancho */
        background: #f8f9fa; /* color de fondo tipo Bootstrap */
        padding: 10px 0;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        z-index: 999;        /* encima de otros elementos */
    }

    .bg-info{
        font-size: 15px!important;
        font-weight: 500;
    }

</style>

 
</head>
<body>

    <!-- Overlay completo -->
<div id="overlaySonido" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 249, 249, 0.808);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
">
    <button id="btnIniciar" style="
        width: 100px;
        height: 100px;
        font-size: 18px;
        border: none;
        border-radius: 50%;
        background-color: #28a745;
        color: white;
        cursor: pointer;
        text-align: center;
    ">Iniciar</button>
</div>

<script>
    let sonidoPermitido = false;

    document.getElementById("btnIniciar").addEventListener("click", function() {
        // Activar sonido
        sonidoPermitido = true;

        // Reproducir sonido inicial si quieres
        let sonido = new Audio("images/BELL1.mp3");
        sonido.play().catch(e => console.log(e));

        // Ocultar overlay
        document.getElementById("overlaySonido").style.display = "none";
    });

    // Funci贸n para reproducir sonido despu茅s
    function reproducirSonido() {
        if (sonidoPermitido) {
            let sonido = new Audio("images/BELL1.mp3");
            sonido.play().catch(e => console.log(e));
        }
    }
</script>


<header style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
">

<!-- Bot贸n flotando a la derecha -->
    <button id="btnCarrito"
        style=" font-size: 25px; border: none; background: transparent;">
         <!--  puedes cambiarlo por  -->
    </button>
    <!-- Logo centrado dentro del header -->
    <div style="flex: 1; text-align: center;">
        <img src="images/logo2.png" width="70">
        <p style="display:none">隆Extremadamente deliciosas. Pruebalas!</p>
    </div>
    <!-- Bot贸n flotando a la derecha -->
    <button id="btnOrdenesModal" onclick="verModalOrdenes()" 
        style=" font-size: 25px; border: none; background: transparent;">
        ★ <!--  puedes cambiarlo por  -->
    </button>
</header>

    <div class="modal-dialog modal-lg" style="padding: 5px;">
        <div class="">
            <div class="modal-header">
                <h5 class="modal-title" id="carritoLabel"> Orden </h5>
                <h5 id="lblOrden">#01-250905</h5>
            </div>
       <center> <span id="lblUbicacion"></span></center>
            <div class="modal-body" id="carritoContenido">
            
            </div>
        </div>
    </div>

<table id="tablaPago" style="width: 50%; margin: 0 auto; color: black; text-align: center;">
    <tr>
        <td>Paga: <input id="lblPagacon" type="text" style="width: 50px; text-align: center; font-weight: 600;"></td>
        <td>Total: <input id="lblTotal" type="text" style="width: 50px; text-align: center; font-weight: 700;"></td>
        <td>Cambio: <input id="lblCambio" type="text" style="width: 50px; text-align: center; font-weight: 600;"></td>
    </tr>
</table>


        <!-- Modal del carrito -->
<div class="modal fade" id="ordenesModal" tabindex="-1" aria-labelledby="carritoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="carritoLabel"> Ordenes Siguientes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="ordenesRestantesContenidoModal" style="padding: 0px;">
        <p>Aqui el slider</p>
      </div>
      <div class="modal-footer">
        <button id="vaciarCarrito" class="btn btn-danger">Vaciar</button>
      </div>
    </div>
  </div>
</div>

<footer class="page-footer">
    
    <center>
        <button id="cancelar" type="button" onclick="terminarOrden('c')" class="btn btn-danger">Cancelar</button>
        &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button id="terminar" type="button" onclick="terminarOrden('t')" class="btn btn-success">Terminar</button>
    </center>
</footer>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

function verModalOrdenes(){
     // Mostrar modal
     verOrdenesRestantes();
  new bootstrap.Modal(document.getElementById("ordenesModal")).show();
}

function reproducirSonido() {
            let sonido = new Audio("images/BELL1.mp3");
            sonido.play().catch(e => console.log(e));
        }

function verOrdenes() {
            $.ajax({
                type: "GET",
                url: "https://amahcarev2.somee.com/apihouse.ashx?Comando=SeleccionarOrdenes",
                contentType: false,
                processData: false,
                dataType: "json", // asegura que jQuery lo trate como JSON
                success: function (result) {

                    if (JSON.stringify(result) != '[]') {
                   // reproducirSonido();
                    var ubicacion = "";
                    var pagacon = "";
                    var total = "";
                    var cambio = "";
                    // Si viene como string, lo parseamos
                    let data = typeof result === 'string' ? JSON.parse(result) : result;
                    // Contenedor donde se agregar谩n las cards
                    let contenedor = $('#carritoContenido');
                    contenedor.empty();
                    // Agrupar por idorden si quieres separar pedidos
                    let pedidos = {};
                    data.forEach(item => {
                        if (!pedidos[item.idorden]) pedidos[item.idorden] = [];
                        pedidos[item.idorden].push(item);
                    });
                    // Crear cards por cada orden
                    for (let idorden in pedidos) {
                        let items = pedidos[idorden];
                        let ul = $('<ul class="list-group mb-3"></ul>');
                        items.forEach(item => {
                            let li = $('<li class="list-group-item" ></li>');
                            // Cabecera con nombre y cantidad
                            let header = $('<div class="d-flex justify-content-between align-items-center"></div>');
                            header.append(`<strong>${item.Producto}</strong>`);
                            header.append(`<span class="badge bg-info rounded-pill">(x${item.Cantidad})</span>`);
                            li.append(header);
                            // Ingredientes
                            if (item.Ingredientes && item.Ingredientes.trim() !== "") {
                                let ingredientesArray = item.Ingredientes.split(',').map(ing => ing.trim());
                                let ingredientesHTML = ingredientesArray.map(ing => `<span class="badge bg-success rounded-pill">${ing}</span>`).join(' ');
                                li.append(`Ingredientes: ${ingredientesHTML}<br>`);
                            }
                            // Opciones (condiciones)
                            if (item.Opciones && item.Opciones.trim() !== "") {
                                let opcionesArray = item.Opciones.split(',').map(op => op.trim());
                                let opcionesHTML = opcionesArray.map(op => `<span class="badge bg-danger rounded-pill">${op}</span>`).join(' ');
                                li.append(`Condiciones: ${opcionesHTML}<br>`);
                            }
                            ul.append(li);

                            ubicacion = item.ubicacion; // obtengo la ubicacion
                            pagacon = item.pagacon; // obtengo la ubicacion
                            total = item.total; // obtengo la ubicacion
                            cambio = item.cambio; // obtengo la ubicacion
                        });
                        contenedor.append(ul);
                        let fecha = new Date(); // puede ser new Date() o un string convertido a Date
                        // Obtener a帽o, mes y d铆a con ceros delante si hace falta
                        let yyyy = fecha.getFullYear();
                        let mm = String(fecha.getMonth() + 1).padStart(2, '0'); // getMonth() va de 0 a 11
                        let dd = String(fecha.getDate()).padStart(2, '0');
                        let fechaFormateada = `${yyyy}${mm}${dd}`;
                        // Asignar al HTML
                        document.getElementById("lblOrden").innerHTML = `#${idorden}-${yyyy}`;
                        document.getElementById("lblUbicacion").innerHTML = ` ${ubicacion}`;
                         document.getElementById("lblPagacon").value = `${pagacon}`;
                          document.getElementById("lblTotal").value = `${total}`;
                           document.getElementById("lblCambio").value = `${cambio.split('.')[0]}`;
                            document.getElementById("tablaPago").style.display = "block";
                    }

                

                } else {
                        console.log("Imagen");
                        document.getElementById("carritoContenido").innerHTML = `
                        <br><br><br>
                            <center><p>No hay 贸rdenes</p>
                            <img src="images/completadas.webp" style="opacity:0.3" width="50%" class="img-fluid"><center
                        `;

                      document.getElementById("tablaPago").style.display = "none";

                }

                },
                error: function (jqXmlHttpRequest, textStatus, errorThrown) {
                    setTimeout(function () { $("#loading").hide(); }, 1000);
                    console.log("Error: "+errorThrown);
                }
            });
        }

        // Ejecutar cada 5 segundos
$(document).ready(function() {
    verOrdenes();
    setInterval(function() {
        // Si no hay <ul> con 贸rdenes dentro del div, hacemos la consulta
        if ($('#carritoContenido ul').length === 0) {
            verOrdenes();
            seleccionarOrdenesAgregadas();
        } else {
            console.log("Carrito tiene contenido, no se hace la consulta.");
              seleccionarOrdenesAgregadas();
        }
    }, 5000);
});



function terminarOrden(estatus){
            var id = document.getElementById("lblOrden").innerHTML.split('-');
            id = id[0].split('#')[1];

            console.log(id + " - " + estatus);
            $.ajax({
                type: "POST",
                url: "https://amahcarev2.somee.com/apihouse.ashx?Comando=TerminarOrden",
                contentType: false,
                processData: false,
                data: JSON.stringify({ IdOrden: id, Estatus: estatus }), //  aqu铆
                success: function (result) {
                    console.log(result)
                     verOrdenes();
                $('#addProdMod').modal('hide');
                // ToastSuccess("Imagen actualizada");
                },
                error: function (jqXmlHttpRequest, textStatus, errorThrown) {
                setTimeout($("#loading").hide(), 1000);
                ToastWarning("Verifique su conexi贸n");
                }
            });
        }






function verOrdenesRestantes() {
    $.ajax({
        type: "GET",
        url: "https://amahcarev2.somee.com/apihouse.ashx?Comando=SeleccionarOrdenesRestantes",
        contentType: false,
        processData: false,
        dataType: "json",
        success: function (result) {
           // console.log("Respuesta cruda:", result);

            if (result && result.length > 0) {
               

                // Desempaquetar el JSON raro
                let raw = result[0]["JSON_F52E2B61-18A1-11d1-B105-00805F49916B"];
                let data = JSON.parse(raw); // ahora s铆 tenemos un array de 贸rdenes
                console.log("rdenes parseadas:", data);

                if (data.length === 0) {
                    $('#ordenesRestantesContenidoModal').html(`
                        <br><br><br>
                        <center><p>No hay 贸rdenes</p>
                        <img src="images/completadas.webp" style="opacity:0.3" width="50%" class="img-fluid"><center>
                    `);
                    return;
                }

                // Construir el carousel
                let carousel = `
                <div id="ordenesCarousel" class="carousel slide" data-bs-ride="carousel">
                  <div class="carousel-inner">`;

                let isActive = true;

                data.forEach(orden => {
                    let ul = $('<ul class="list-group mb-3"></ul>');

                    orden.productos.forEach(prod => {
                        let li = $('<li class="list-group-item"></li>');
                        let header = $('<div class="d-flex justify-content-between align-items-center"></div>');
                        header.append(`<strong>${prod.Producto}</strong>`);
                        header.append(`<span class="badge bg-info rounded-pill">(x${prod.Cantidad})</span>`);
                        li.append(header);

                        if (prod.Ingredientes && prod.Ingredientes.trim() !== "") {
                            let ingredientesArray = prod.Ingredientes.split(',').map(ing => ing.trim());
                            let ingredientesHTML = ingredientesArray.map(ing => `<span class="badge bg-success rounded-pill">${ing}</span>`).join(' ');
                            li.append(`Ingredientes: ${ingredientesHTML}<br>`);
                        }

                        if (prod.Opciones && prod.Opciones.trim() !== "") {
                            let opcionesArray = prod.Opciones.split(',').map(op => op.trim());
                            let opcionesHTML = opcionesArray.map(op => `<span class="badge bg-danger rounded-pill">${op}</span>`).join(' ');
                            li.append(`Condiciones: ${opcionesHTML}<br>`);
                        }

                        ul.append(li);
                    });

                    let ulHtml = $('<div>').append(ul).html();

                    carousel += `
                      <div class="carousel-item ${isActive ? 'active' : ''}">
                        <div class="card p-3">
                          <h5>Orden #${orden.idorden}</h5>
                          <p><strong></strong> ${orden.ubicacion}</p>
                          ${ulHtml}
                          
                        </div>
                      </div>`;
                    isActive = false;
                });

                carousel += `
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#ordenesCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="false"></span>
                    <span class="visually-hidden">Anterior</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#ordenesCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="false"></span>
                    <span class="visually-hidden">Siguiente</span>
                  </button>
                </div>
                
                <style>
/* Sobrescribir icono next a negro */
.carousel-control-next-icon {
    background-image: url("data:image/svg+xml;charset=UTF8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='black' viewBox='0 0 8 8'%3E%3Cpath d='M2.5 0l-1.4 1.4 2.6 2.6-2.6 2.6 1.4 1.4 4-4-4-4z'/%3E%3C/svg%3E");
}
.carousel-control-prev-icon {
    background-image: url("data:image/svg+xml;charset=UTF8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='black' viewBox='0 0 8 8'%3E%3Cpath d='M5.5 0l1.4 1.4-2.6 2.6 2.6 2.6-1.4 1.4-4-4 4-4z'/%3E%3C/svg%3E");
}
</style>
                `;

                // Insertar en el modal
                $('#ordenesRestantesContenidoModal').html(carousel);

            } else {
                $('#ordenesRestantesContenidoModal').html(`
                    <br><br><br>
                    <center><p>No hay 贸rdenes</p>
                    <img src="images/completadas.webp" style="opacity:0.3" width="50%" class="img-fluid"><center>
                `);
            }
        },
        error: function (jqXmlHttpRequest, textStatus, errorThrown) {
            console.log("Error: " + errorThrown);
        }
    });
}



function seleccionarOrdenesAgregadas() {
    $.ajax({
        type: "GET",
        url: "https://amahcarev2.somee.com/apihouse.ashx?Comando=SeleccionarOrdenesAgregadas",
        contentType: false,
        processData: false,
        dataType: "json",
        success: function (result) {
           
            if(result[0].idorden != null){
                reproducirSonido();
            }
            
        },
        error: function (jqXmlHttpRequest, textStatus, errorThrown) {
            console.log("Error: " + errorThrown);
        }
    });
}
























          

    </script>
</body>
</html>
